# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  config.vm.define "minikube" do |node|
    node.vm.box = "ubuntu/jammy64"
    node.vm.hostname = "minikube"

    # Static IP to avoid host-only conflicts
    node.vm.network "private_network", ip: "192.168.56.50"

    # VM resources
    node.vm.provider "virtualbox" do |vb|
      vb.name = "minikube"
      vb.memory = "4096"
      vb.cpus = 2
      vb.customize ["modifyvm", :id, "--nested-hw-virt", "on"]
    end

    # Disable synced folder for speed
    node.vm.synced_folder ".", "/vagrant", disabled: true

    # Provision VM (idempotent)
    node.vm.provision "shell", inline: <<-SHELL
      echo "==> Updating packages"
      sudo apt-get update -y

      echo "==> Installing dependencies"
      for pkg in apt-transport-https ca-certificates curl conntrack git; do
        if ! dpkg -s $pkg >/dev/null 2>&1; then
          sudo apt-get install -y $pkg
        else
          echo "$pkg is already installed, skipping..."
        fi
      done

      echo "==> Installing Docker"
      if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com | bash
        sudo usermod -aG docker vagrant
      else
        echo "Docker is already installed, skipping..."
      fi

      echo "==> Installing kubectl"
      if ! command -v kubectl >/dev/null 2>&1; then
        curl -LO "https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
        rm kubectl
      else
        echo "kubectl is already installed, skipping..."
      fi

      echo "==> Installing Minikube"
      if ! command -v minikube >/dev/null 2>&1; then
        curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube_latest_amd64.deb
        sudo dpkg -i minikube_latest_amd64.deb
        rm minikube_latest_amd64.deb
      else
        echo "Minikube is already installed, skipping..."
      fi

      echo "==> All prerequisites installed."
      echo "==> You can now login and run: minikube start --driver=docker"
    SHELL

  end
end
